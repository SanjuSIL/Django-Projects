<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Push Notification Demo</title>
</head>
<body>
  <h1>Push Notification Demo</h1>
  <button id="enable-notifications">Enable Notifications</button>
  
  <script>
    // Replace with your actual public VAPID key
    const publicVapidKey = "BGmYRdxITPNLhnmoEJMQ1_34wh-TzeHF1W5fifBI2tBzqllgcgXzrqROV4MC5qHuhxMgwpko6XKcBRS1JJggQc4";

    // Request notification permission from the user
    function requestNotificationPermission() {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("Notifications allowed!");
          registerServiceWorker();
        } else {
          console.log("Notifications denied!");
        }
      });
    }

    // Converts a URL-safe Base64 string to a Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Register the service worker
    function registerServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/static/notifications/js/sw.js")
          .then(registration => {
            console.log("Service Worker Registered", registration);
            subscribeUser(registration);
          })
          .catch(error => {
            console.error("Service Worker registration failed:", error);
          });
      } else {
        console.error("Service workers are not supported in this browser.");
      }
    }

    // Subscribe the user to push notifications
    function subscribeUser(registration) {
      registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
      })
      .then(subscription => {
        console.log("Push Subscription:", subscription);
        // Send the subscription to the server for storage
        fetch("/notifications/subscribe/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(subscription)
        })
        .then(response => response.json())
        .then(data => console.log("Subscription saved:", data))
        .catch(error => console.error("Subscription failed:", error));
      })
      .catch(error => console.error("Push subscription error:", error));
    }

    // Set up the click event listener to request notification permission
    document.getElementById("enable-notifications")
      .addEventListener("click", requestNotificationPermission);
  </script>
</body>
</html>
